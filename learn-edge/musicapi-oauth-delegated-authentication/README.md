Apigee Delegated Token Management
=========

##Music OAuth 2.0 Delegated Authentication API Bundle
This API bundle provides an example of an API Proxy secured-based resource by Delegated Token Service and Apigee. So, that an access token can be generated by a third party such as Google OAuth API and yet use the same token to restrict access to a resource on Apigee.

A typical use of this flow can be better described by the following sequence diagram:

**Source: http://goo.gl/LgeuYw**

![Apigee Delegated Token Management sample flow](http://www.websequencediagrams.com/cgi-bin/cdraw?lz=dGl0bGUgT0F1dGggMi4wIERlbGVnYXRlZCBUb2tlbiBNYW5hZ2VtZW50L0F1dGhlbnRpY2F0aW9uCgpwYXJ0aWNpcGFudCAiQ29uc3VtZXIgQXBwXG5Vc2VyIEFnZW50XG5lLmcuIEJyb3dzZXIiIGFzIENsaWVudAAjHFNlcnZlciBTaWRlAEoGAD8FV1dXLCBUb21jYXQsXG5Ob2RlLmpzLCBldGMuAFMFADAGU2lkZUFwcACBEA5BcGkgUHJveHlcbiAAgQsFQXBpZ2VlAIEKBQAFBgCBQA5JZFAAgTIHR29vZwCCFQwsIFxuRmFjZWJvb2ssIFR3aXR0ZXIsIFxuUGluZywgRm9yZ2VSb2NrAIFlBVBpbmdGZWRlcmF0AFIPVGFyZ2UAghUITXVzaWMgQVBJIACCGwUAFgYKCm5vdGUgb3ZlcgCCKwcsAIFUDTogAIJnDCBhYnN0cmFjAIMVBWVuZCBub3RlADcLAIFqBiwAgQUMOiAgIElkUAAuDAAwFgCDKgYtPgCCLgY6ICAvdG9rZW4KAII-BgAOCnZlcmlmeSBhcGlrZXkAgTgGcmlnaHQgb2YAgmkHOiBBZGRpdGlvbmFsIHNlY3VyaXR5IG1heWJlIHJlcXVpcmVkIHRvABUGZSBpbnRlAIFNB1xuIHdpdGggdXNlciBhZ2VudC4gT3UAVgVzY29wZSBvZiB0aGlzIHR1dG9yaWFsAIF7CgCBHwgAhHEGOiAzMDIgcmVkaXJlY3QAgVMJAIILDi9sb2dpbgoAgzMMABMQR2VuAINSBSBhdXRoIGNvZGUAIA8AWxQgcmV0dXJuACkLAIJUCACDTA8vYXV0aABQBQCFSA0AgnoKABgJICgAgmoGLCBzZWNyZXQsIGNhbGxiYWNrdXJsKQCDGwkAg2sOAIMiCABdCACBWw4Ag2AIAIEmBwCDaAUgYW5kAIJ4BWlkAINnEXNhdmUAHghzIGV4dGVybmFsADEHAIMtCWlkIFxuABQMYXR0cmlidQCDDxMAbQwAhG0RL3Jlc291cmNlICgAhQIFAIFaCgCEfwlhbGlkYXQAgQ0HLCByZXRyaWV2ZQCBMBAAhn4GAEYMAIEiCw&s=modern-blue "Apigee Delegated Token Management sample flow")


### Deploying API bundle with Grunt.js
This API Bundle can be deployed by leveraging [Apigee Deploy Grunt.js Plugin](https://github.com/apigeecs/apigee-deploy-grunt-plugin) or via any tool that can import Apigee proxy bundles.

#### Step 1: Test oauth-delegated/generatetoken resource
The following command demonstrates how to send a request with an access token that gets stored by Apigee OAuthV2 Policy, and then used for subsequent requests.

In a real scenario, the client would never set the access token, however this example gives you an idea how to set the variables that will get stored in Apigee to be able to save them as the token instead of Apigee Generated token. Regardless of whether these values are generated either by the client or the server app preferably. An implementation closer to a more production one would make a request to an OAuth Provider, for instance Google OAuth Service and then store access and refresh tokens in Apigee as custom attributes. See suggestion provided from [StackOverflow answer](http://stackoverflow.com/questions/23710888/apigee-oauth-authorization).

```bash
curl https://testmyapi-test.apigee.net/oauth-delegated/generatetoken\?external_access_token\=123456 \
-d 'client_id=sxnS7SddD6494Akbqk74ej4SmvvqjL0O&grant_type=client_credentials' -v
```

will produce:

```json
      {
  "issued_at" : "1415467907287",
  "application_name" : "99d3f4de-e501-4836-9bdd-f552e1d4b923",
  "scope" : "WRITE",
  "status" : "approved",
  "api_product_list" : "[PremiumWeatherAPI]",
  "expires_in" : "1799",
  "developer.email" : "tesla@weathersample.com",
  "organization_id" : "0",
  "token_type" : "BearerToken",
  "client_id" : "sxnS7SddD6494Akbqk74ej4SmvvqjL0O",
  "access_token" : "123456",
  "organization_name" : "testmyapi",
  "refresh_token_expires_in" : "0",
  "refresh_count" : "0"
}
```

**Note:** Access token generated is the same as the access token sent in the cURL command from step 1.

#### Step 2: Test /oauth-external/testtoken
The following request tests that the access token "generated" in step 1 is valid to access a protected resource, in our case /music.

```bash
curl https://testmyapi-test.apigee.net/oauth-delegated/music\?func\=getSong\&artist\=radiohead\&fmt\=json -H 'Authorization:Bearer 123456'
```

will produce:
```json
200 OK

      {
         "artist": "Radiohead",
           "albums": [
             {
               "album": "Pablo Honey",
               "year": "1993",
               }, ...
            ]
      }
```

#### How did we get to store the token?
Policies under apiproxy are defined to implement this behavior.

##### OAuth-v20-Verify-Token.xml Policy
Note a the following parameters parameters in this policy:

- ExternalAuthoriation set to true
- ExternalAccessToken set to request.queryparam.external_access_token. External access token is being provided in the request, however this parameter can be set with any other variable generated from an external token service.
- StoreToken set to true. Otherwise the token will never be persisted.


```xml
<OAuthV2 async="false" continueOnError="false" enabled="true" name="OAuth-v20-Verify-Token">
    <DisplayName>OAuth v2.0 1</DisplayName>
    <FaultRules/>
    <Properties/>
    <Attributes/>
    <ExternalAuthorization>true</ExternalAuthorization>
    <Operation>GenerateAccessToken</Operation>
    <SupportedGrantTypes> <!-- Optional -->
        <GrantType>client_credentials</GrantType>
    </SupportedGrantTypes>
    <GenerateResponse enabled="true"/>
    <ExternalAccessToken>request.queryparam.external_access_token</ExternalAccessToken>
   <StoreToken>true</StoreToken> 
    <Tokens/>
</OAuthV2>
```

##### Assign-Message-Set-Variables.xml Policy
This policy sets a variable required to enable external authorization.
```xml

    <AssignVariable>
        <Name>oauth_external_authorization_status</Name>
        <Value>true</Value>
    </AssignVariable>
```

#### Run tests via Mocha
Tests can be executed by either deploying the api with this command:
```bash
 grunt --env=test --username=$ae_username --password=$ae_password --debug
```
 or running tests directly:
```bash
grunt mochaTest --env=test
```